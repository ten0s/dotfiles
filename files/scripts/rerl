#!/bin/bash

if [[ $# -ne 1 ]] && [[ $# -ne 2 ]] && [[ $# -ne 3 ]]; then
    echo "[R]emote [ERL]ang node helper"
    echo "Usage: $(basename $0) <NAME@HOST> [<ping> | remsh | entop | cookie | call <MFA>]"
    echo "Where:"
    echo "  ping   - Start the local node and ping the remote node (default)"
    echo "  remsh  - Connect to the remote node"
    echo "  entop  - Connect entop to the remote node"
    echo "  cookie - Print remote node's cookie"
    echo "  call   - Make a RPC call. MFA must be \"Module, Function, [Args]\""
    exit 1
fi

node=$1
cmd=${2-ping}

host=$(echo $node | awk -F@ '{print $2}')
case $host in
10.249.*)
    name="-name adm$$@127.0.0.1"
    cookie=$(ssh $host 'cat .erlang.cookie')
    ;;
10.252.*)
    name="-name adm$$@127.0.0.1"
    cookie=$(ssh $host 'sudo cat /home/*/.erlang.cookie')
    ;;
$(hostname))
    name="-sname adm$$"
    cookie=$(cat ~/.erlang.cookie)
    ;;
*)
    echo "Unknown host: $host"
    exit 1
esac

case $cmd in
cookie)
    echo $cookie
    ;;
ping)
    echo "Exit with double Ctrl-C"
    erl $name -setcookie $cookie -eval "net_adm:ping('$node')."
    ;;
remsh)
    echo "Exit with double Ctrl-C"
    erl $name -hidden -setcookie $cookie -remsh $node
    ;;
entop)
    entop $node $name -setcookie $cookie
    ;;
call)
   mfa=${3-"erlang, node, []"}
   erl $name -hidden -noshell -setcookie $cookie -eval "io:format(\"~p~n\", [rpc:call('$node', $mfa)]), init:stop()."
   ;;
*)
    echo "Unknown command: $cmd"
    exit 1
esac
